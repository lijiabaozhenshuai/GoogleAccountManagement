{% extends "base.html" %}

{% block content %}
<!-- åˆ›å»ºé…ç½®åŒºåŸŸ -->
<div class="create-config-section">
    <div class="config-card">
        <div class="config-header">
            <h3><i data-lucide="settings"></i> åˆ›å»ºé…ç½®</h3>
        </div>
        <div class="config-body">
            <div class="config-row">
                <div class="config-item">
                    <label class="config-label">åˆ›å»ºæ•°é‡</label>
                    <input type="number" id="create-count" class="form-input" value="1" min="1" max="100">
                    <span class="config-hint">å¯ç”¨èŠ‚ç‚¹: <strong id="available-nodes">0</strong> ä¸ª</span>
                </div>
                <div class="config-item">
                    <label class="config-label">ç¯å¢ƒåˆ†ç»„</label>
                    <select id="group-select" class="form-select">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                    <span class="config-hint">ğŸ’¡ æç¤ºï¼šå¦‚éœ€åˆ›å»ºæ–°åˆ†ç»„ï¼Œè¯·å…ˆåœ¨ HubStudio å®¢æˆ·ç«¯ä¸­æ“ä½œ</span>
                </div>
                <div class="config-item">
                    <label class="config-label">å†…æ ¸ç‰ˆæœ¬</label>
                    <select id="core-version" class="form-select">
                        <option value="random">éšæœºé€‰æ‹©</option>
                        <option value="131">Chrome 131</option>
                        <option value="130">Chrome 130</option>
                        <option value="128">Chrome 128</option>
                        <option value="126">Chrome 126</option>
                        <option value="124">Chrome 124</option>
                        <option value="122">Chrome 122</option>
                        <option value="117">Chrome 117</option>
                        <option value="113">Chrome 113</option>
                        <option value="112">Chrome 112</option>
                    </select>
                </div>
            </div>
            <div class="config-actions">
                <button class="btn btn-primary btn-lg" id="start-btn" onclick="startCreate()">
                    <i data-lucide="play"></i>
                    <span>å¼€å§‹åˆ›å»º</span>
                </button>
                <button class="btn btn-outline" onclick="refreshData()">
                    <i data-lucide="refresh-cw"></i>
                    <span>åˆ·æ–°æ•°æ®</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- APIçŠ¶æ€ -->
<div class="status-bar" id="api-status">
    <div class="status-item">
        <span class="status-label">HubStudio API:</span>
        <span class="status-value" id="hubstudio-status">
            <i data-lucide="loader" class="spin"></i> æ£€æµ‹ä¸­...
        </span>
    </div>
</div>

<!-- è¿›åº¦åŒºåŸŸ -->
<div class="progress-section" id="progress-section" style="display: none;">
    <div class="progress-header">
        <h3><i data-lucide="activity"></i> åˆ›å»ºè¿›åº¦</h3>
        <span class="progress-stats">
            <span class="stat success"><i data-lucide="check-circle"></i> <span id="success-count">0</span></span>
            <span class="stat failed"><i data-lucide="x-circle"></i> <span id="failed-count">0</span></span>
            <span class="stat total"><i data-lucide="layers"></i> <span id="current-count">0</span>/<span id="total-count">0</span></span>
        </span>
    </div>
    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>
</div>

<!-- æ—¥å¿—åŒºåŸŸ -->
<div class="log-section">
    <div class="log-header">
        <h3><i data-lucide="terminal"></i> æ“ä½œæ—¥å¿—</h3>
        <button class="btn btn-sm btn-outline" onclick="clearLogs()">
            <i data-lucide="trash-2"></i>
            <span>æ¸…ç©º</span>
        </button>
    </div>
    <div class="log-container" id="log-container">
        <div class="log-empty">
            <i data-lucide="file-text"></i>
            <p>æš‚æ— æ—¥å¿—</p>
        </div>
    </div>
</div>

<!-- åˆ›å»ºç»“æœæ‘˜è¦ -->
<div class="result-section" id="result-section" style="display: none;">
    <div class="result-header">
        <h3><i data-lucide="check-circle"></i> åˆ›å»ºå®Œæˆ</h3>
        <button class="btn btn-sm btn-primary" onclick="exportResults()">
            <i data-lucide="download"></i>
            <span>å¯¼å‡ºç¯å¢ƒID</span>
        </button>
    </div>
    <div class="result-summary">
        <p>âœ… æ‰¹é‡åˆ›å»ºä»»åŠ¡å·²å®Œæˆï¼æˆåŠŸåˆ›å»º <strong id="final-success-count">0</strong> ä¸ªç¯å¢ƒã€‚</p>
        <p>ğŸ’¡ å¯å‰å¾€ <a href="/browser-list" style="color: var(--primary-color); text-decoration: underline;">æµè§ˆå™¨çª—å£åˆ—è¡¨</a> æŸ¥çœ‹æ‰€æœ‰çª—å£ã€‚</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.create-config-section {
    margin-bottom: 20px;
}

.config-card {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.config-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.05) 100%);
}

.config-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    color: var(--text-primary);
}

.config-header h3 i {
    width: 20px;
    height: 20px;
    color: var(--primary-color);
}

.config-body {
    padding: 20px;
}

.config-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.config-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.config-label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
}

.config-hint {
    font-size: 12px;
    color: var(--text-muted);
}

.config-hint strong {
    color: var(--primary-color);
}

.form-select {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 14px;
    outline: none;
    transition: all 0.2s;
}

.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.config-actions {
    display: flex;
    gap: 12px;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 15px;
}

.status-bar {
    display: flex;
    gap: 24px;
    padding: 12px 16px;
    background: var(--card-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.status-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.status-value {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    font-weight: 500;
}

.status-value.online {
    color: #10b981;
}

.status-value.offline {
    color: #ef4444;
}

.status-value i {
    width: 14px;
    height: 14px;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.progress-section {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    padding: 20px;
    margin-bottom: 20px;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.progress-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
}

.progress-header h3 i {
    width: 18px;
    height: 18px;
    color: var(--primary-color);
}

.progress-stats {
    display: flex;
    gap: 16px;
}

.progress-stats .stat {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    font-weight: 500;
}

.progress-stats .stat i {
    width: 14px;
    height: 14px;
}

.progress-stats .stat.success {
    color: #10b981;
}

.progress-stats .stat.failed {
    color: #ef4444;
}

.progress-stats .stat.total {
    color: var(--text-secondary);
}

.progress-bar-container {
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #6366f1, #8b5cf6);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.log-section {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    overflow: hidden;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0, 0, 0, 0.02);
}

.log-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.log-header h3 i {
    width: 16px;
    height: 16px;
    color: var(--text-secondary);
}

.log-container {
    height: 240px;
    overflow-y: auto;
    padding: 12px;
    background: #1a1a2e;
    font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
    font-size: 12px;
}

.log-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #666;
}

.log-empty i {
    width: 32px;
    height: 32px;
    margin-bottom: 8px;
    opacity: 0.5;
}

.log-line {
    padding: 4px 0;
    line-height: 1.5;
    color: #a0aec0;
}

.log-line.info {
    color: #63b3ed;
}

.log-line.success {
    color: #68d391;
}

.log-line.error {
    color: #fc8181;
}

.log-line.warning {
    color: #f6e05e;
}

.log-time {
    color: #718096;
    margin-right: 8px;
}

.result-section {
    background: var(--card-bg);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
}

.result-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.result-header h3 i {
    width: 16px;
    height: 16px;
    color: var(--primary-color);
}

.result-summary {
    padding: 20px;
    text-align: center;
}

.result-summary p {
    margin: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
}

.result-summary strong {
    color: var(--primary-color);
    font-size: 18px;
}
</style>

<script>
let isCreating = false;
let createdResults = [];

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    checkApiStatus();
    loadGroups();
    loadAvailableNodes();
});

// æ£€æŸ¥APIçŠ¶æ€
async function checkApiStatus() {
    const statusEl = document.getElementById('hubstudio-status');
    try {
        const res = await fetch('/api/hubstudio/status');
        const data = await res.json();
        if (data.code === 0 && data.data.connected) {
            statusEl.innerHTML = '<i data-lucide="check-circle"></i> å·²è¿æ¥';
            statusEl.className = 'status-value online';
        } else {
            statusEl.innerHTML = '<i data-lucide="x-circle"></i> æœªè¿æ¥';
            statusEl.className = 'status-value offline';
        }
    } catch (e) {
        statusEl.innerHTML = '<i data-lucide="x-circle"></i> è¿æ¥å¤±è´¥';
        statusEl.className = 'status-value offline';
    }
    lucide.createIcons();
}

// åŠ è½½åˆ†ç»„åˆ—è¡¨
async function loadGroups() {
    const selectEl = document.getElementById('group-select');
    try {
        const res = await fetch('/api/hubstudio/groups');
        const data = await res.json();
        if (data.code === 0 && data.data.length > 0) {
            selectEl.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>' + 
                data.data.map(g => 
                    `<option value="${g.tagCode}">${escapeHtml(g.tagName)}</option>`
                ).join('');
        } else {
            selectEl.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>';
        }
    } catch (e) {
        selectEl.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>';
    }
}

// åŠ è½½å¯ç”¨èŠ‚ç‚¹æ•°é‡
async function loadAvailableNodes() {
    try {
        const res = await fetch('/api/nodes/available-count');
        const data = await res.json();
        document.getElementById('available-nodes').textContent = data.count || 0;
        document.getElementById('create-count').max = data.count || 0;
    } catch (e) {
        document.getElementById('available-nodes').textContent = '0';
    }
}

// åˆ·æ–°æ•°æ®
function refreshData() {
    checkApiStatus();
    loadGroups();
    loadAvailableNodes();
    addLog('info', 'æ•°æ®å·²åˆ·æ–°');
}

// å¼€å§‹åˆ›å»º
async function startCreate() {
    if (isCreating) {
        showToast('æ­£åœ¨åˆ›å»ºä¸­ï¼Œè¯·ç¨å€™', 'warning');
        return;
    }

    const count = parseInt(document.getElementById('create-count').value);
    const groupCode = document.getElementById('group-select').value;
    const coreVersion = document.getElementById('core-version').value;

    if (!count || count < 1) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ›å»ºæ•°é‡', 'error');
        return;
    }

    // groupCode å¯ä»¥ä¸ºç©ºï¼Œè¡¨ç¤ºä¸åˆ†ç»„

    // æ£€æŸ¥å¯ç”¨èŠ‚ç‚¹
    const availableNodes = parseInt(document.getElementById('available-nodes').textContent);
    if (count > availableNodes) {
        showToast(`å¯ç”¨èŠ‚ç‚¹ä¸è¶³ï¼Œå½“å‰ä»…æœ‰ ${availableNodes} ä¸ªæœªä½¿ç”¨èŠ‚ç‚¹`, 'error');
        return;
    }

    isCreating = true;
    createdResults = [];
    
    // æ›´æ–°UI
    document.getElementById('start-btn').disabled = true;
    document.getElementById('progress-section').style.display = 'block';
    document.getElementById('result-section').style.display = 'none';
    document.getElementById('success-count').textContent = '0';
    document.getElementById('failed-count').textContent = '0';
    document.getElementById('current-count').textContent = '0';
    document.getElementById('total-count').textContent = count;
    document.getElementById('progress-bar').style.width = '0%';

    addLog('info', `å¼€å§‹æ‰¹é‡åˆ›å»º ${count} ä¸ªæµè§ˆå™¨çª—å£...`);

    try {
        const res = await fetch('/api/hubstudio/batch-create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                count: count,
                group_code: groupCode,
                core_version: coreVersion
            })
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let successCount = 0;
        let failedCount = 0;

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const text = decoder.decode(value);
            const lines = text.split('\n').filter(line => line.startsWith('data: '));

            for (const line of lines) {
                try {
                    const data = JSON.parse(line.substring(6));
                    handleCreateEvent(data);
                    
                    if (data.type === 'progress') {
                        if (data.success) {
                            successCount++;
                        } else {
                            failedCount++;
                        }
                        const current = successCount + failedCount;
                        document.getElementById('success-count').textContent = successCount;
                        document.getElementById('failed-count').textContent = failedCount;
                        document.getElementById('current-count').textContent = current;
                        document.getElementById('progress-bar').style.width = `${(current / count) * 100}%`;
                    }
                } catch (e) {
                    console.error('Parse error:', e);
                }
            }
        }

        addLog('success', `åˆ›å»ºå®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failedCount}`);
        document.getElementById('result-section').style.display = 'block';
        document.getElementById('final-success-count').textContent = successCount;
        loadAvailableNodes(); // åˆ·æ–°å¯ç”¨èŠ‚ç‚¹æ•°

    } catch (e) {
        addLog('error', `åˆ›å»ºå¤±è´¥: ${e.message}`);
    } finally {
        isCreating = false;
        document.getElementById('start-btn').disabled = false;
    }
}

// å¤„ç†åˆ›å»ºäº‹ä»¶
function handleCreateEvent(data) {
    if (data.type === 'log') {
        addLog(data.level, data.message);
    } else if (data.type === 'progress') {
        createdResults.push(data);
    }
}

// æ·»åŠ æ—¥å¿—
function addLog(level, message) {
    const container = document.getElementById('log-container');
    const emptyEl = container.querySelector('.log-empty');
    if (emptyEl) {
        emptyEl.remove();
    }

    const time = new Date().toLocaleTimeString();
    const logLine = document.createElement('div');
    logLine.className = `log-line ${level}`;
    logLine.innerHTML = `<span class="log-time">[${time}]</span>${escapeHtml(message)}`;
    container.appendChild(logLine);
    container.scrollTop = container.scrollHeight;
}

// æ¸…ç©ºæ—¥å¿—
function clearLogs() {
    const container = document.getElementById('log-container');
    container.innerHTML = `
        <div class="log-empty">
            <i data-lucide="file-text"></i>
            <p>æš‚æ— æ—¥å¿—</p>
        </div>
    `;
    lucide.createIcons();
}

// å¯¼å‡ºç»“æœ
function exportResults() {
    if (createdResults.length === 0) {
        showToast('æš‚æ— å¯å¯¼å‡ºçš„ç»“æœ', 'warning');
        return;
    }

    const successResults = createdResults.filter(r => r.success);
    if (successResults.length === 0) {
        showToast('æ²¡æœ‰æˆåŠŸåˆ›å»ºçš„ç¯å¢ƒ', 'warning');
        return;
    }

    const content = successResults.map(r => r.container_code).join('\n');
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `HUBç¯å¢ƒID_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast(`å·²å¯¼å‡º ${successResults.length} ä¸ªç¯å¢ƒID`, 'success');
}
</script>
{% endblock %}

