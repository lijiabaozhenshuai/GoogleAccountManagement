{% extends "base.html" %}

{% block content %}
<!-- 工具栏 -->
<div class="toolbar">
    <div class="toolbar-left">
        <button class="btn btn-primary" onclick="openAddModal()">
            <i data-lucide="plus"></i>
            <span>添加节点</span>
        </button>
    </div>
    <div class="toolbar-right">
        <button class="btn btn-outline" onclick="showImportRules()">
            <i data-lucide="help-circle"></i>
            <span>导入说明</span>
        </button>
        <div class="file-upload">
            <input type="file" id="import-file" accept=".xlsx,.xls" onchange="importData(this)">
            <label for="import-file" class="file-upload-label">
                <i data-lucide="upload"></i>
                <span>导入</span>
            </label>
        </div>
        <button class="btn btn-outline" onclick="exportData()">
            <i data-lucide="download"></i>
            <span>导出</span>
        </button>
    </div>
</div>

<!-- 批量操作栏 -->
<div class="batch-bar" id="batch-bar">
    <span class="selected-count">已选择 <span id="selected-count">0</span> 条</span>
    <div class="batch-actions">
        <button class="btn btn-sm btn-success" onclick="batchUpdateStatus(true)">
            <i data-lucide="check"></i>
            <span>标记已使用</span>
        </button>
        <button class="btn btn-sm btn-warning" onclick="batchUpdateStatus(false)">
            <i data-lucide="x"></i>
            <span>标记未使用</span>
        </button>
        <button class="btn btn-sm btn-danger" onclick="batchDelete()">
            <i data-lucide="trash-2"></i>
            <span>批量删除</span>
        </button>
    </div>
</div>

<!-- 数据表格 -->
<div class="table-container">
    <table class="data-table" id="data-table">
        <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" class="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th style="width: 60px; text-align: center;">序号</th>
                <th>节点IP</th>
                <th>端口</th>
                <th>用户名</th>
                <th>密码</th>
                <th>状态</th>
                <th>创建时间</th>
                <th class="actions-cell">操作</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- 数据动态加载 -->
        </tbody>
    </table>
    <div class="empty-state" id="empty-state" style="display: none;">
        <i data-lucide="inbox"></i>
        <p>暂无数据</p>
    </div>
</div>

<!-- 分页组件 -->
<div class="pagination-container" id="pagination-container" style="display: none;">
    <div class="pagination-info">
        共 <span id="total-count">0</span> 条记录，第 <span id="current-page">1</span> / <span id="total-pages">1</span> 页
    </div>
    <div class="pagination-controls">
        <button class="btn btn-sm btn-outline" id="first-page" onclick="goToPage(1)">首页</button>
        <button class="btn btn-sm btn-outline" id="prev-page" onclick="goToPage(currentPage - 1)">上一页</button>
        <div class="page-numbers" id="page-numbers"></div>
        <button class="btn btn-sm btn-outline" id="next-page" onclick="goToPage(currentPage + 1)">下一页</button>
        <button class="btn btn-sm btn-outline" id="last-page" onclick="goToPage(totalPages)">末页</button>
    </div>
    <div class="pagination-size">
        每页显示：
        <select class="form-select-sm" id="page-size" onchange="changePageSize(this.value)">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
        条
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/api/nodes';
    const COLUMNS = ['ip', 'port', 'username', 'password'];
    const COLUMN_LABELS = {
        ip: '节点IP',
        port: '端口',
        username: '用户名',
        password: '密码'
    };
    
    // 分页变量
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let totalCount = 0;

    // 页面加载时获取数据
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
    });

    // 加载数据
    async function loadData() {
        try {
            const res = await fetch(`${API_BASE}?page=${currentPage}&page_size=${pageSize}`);
            const data = await res.json();
            if (data.code === 0) {
                totalCount = data.total;
                totalPages = data.total_pages;
                currentPage = data.page;
                renderTable(data.data);
                renderPagination();
            }
        } catch (error) {
            showToast('加载数据失败', 'error');
        }
    }
    
    // 渲染分页
    function renderPagination() {
        const paginationContainer = document.getElementById('pagination-container');
        const pageNumbers = document.getElementById('page-numbers');
        
        if (totalCount === 0) {
            paginationContainer.style.display = 'none';
            return;
        }
        
        paginationContainer.style.display = 'flex';
        document.getElementById('total-count').textContent = totalCount;
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        
        // 渲染页码按钮
        pageNumbers.innerHTML = '';
        const maxPages = 5; // 最多显示5个页码
        let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);
        
        if (endPage - startPage < maxPages - 1) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline'}`;
            btn.textContent = i;
            btn.onclick = () => goToPage(i);
            pageNumbers.appendChild(btn);
        }
        
        // 更新按钮状态
        document.getElementById('first-page').disabled = currentPage === 1;
        document.getElementById('prev-page').disabled = currentPage === 1;
        document.getElementById('next-page').disabled = currentPage === totalPages;
        document.getElementById('last-page').disabled = currentPage === totalPages;
    }
    
    // 跳转到指定页
    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        loadData();
    }
    
    // 改变每页显示数量
    function changePageSize(size) {
        pageSize = parseInt(size);
        currentPage = 1; // 重置到第一页
        loadData();
    }

    // 渲染表格
    function renderTable(items) {
        const tbody = document.getElementById('table-body');
        const emptyState = document.getElementById('empty-state');
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'flex';
            return;
        }
        
        emptyState.style.display = 'none';
        tbody.innerHTML = items.map((item, index) => {
            // 计算当前页的显示序号
            const displayIndex = (currentPage - 1) * pageSize + (index + 1);
            
            return `
            <tr data-id="${item.id}">
                <td class="checkbox-cell">
                    <input type="checkbox" class="checkbox row-checkbox" value="${item.id}" onchange="updateSelection()">
                </td>
                <td style="text-align: center; color: var(--text-secondary);">${displayIndex}</td>
                <td>${escapeHtml(item.ip)}</td>
                <td>${item.port}</td>
                <td>${escapeHtml(item.username)}</td>
                <td>${escapeHtml(item.password)}</td>
                <td>
                    <span class="status-tag ${item.status ? 'used' : 'unused'}">
                        ${item.status ? '已使用' : '未使用'}
                    </span>
                </td>
                <td>${item.created_at}</td>
                <td class="actions-cell">
                    <div class="action-btns">
                        <button class="action-btn edit" onclick="openEditModal(${item.id})" title="编辑">
                            <i data-lucide="pencil"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteItem(${item.id})" title="删除">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `}).join('');
        
        lucide.createIcons();
    }

    // 打开添加弹窗
    function openAddModal() {
        showModal('添加节点', `
            <form id="add-form">
                <div class="form-group">
                    <label class="form-label">节点IP<span class="required">*</span></label>
                    <input type="text" class="form-input" name="ip" placeholder="例如: 192.168.1.1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">端口<span class="required">*</span></label>
                    <input type="number" class="form-input" name="port" placeholder="例如: 8080" required>
                </div>
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-input" name="username">
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <input type="text" class="form-input" name="password">
                </div>
                <div class="form-group">
                    <label class="form-label">状态</label>
                    <div class="form-switch">
                        <label class="switch">
                            <input type="checkbox" name="status">
                            <span class="switch-slider"></span>
                        </label>
                        <span>已使用</span>
                    </div>
                </div>
            </form>
        `, async () => {
            const form = document.getElementById('add-form');
            const formData = new FormData(form);
            const data = {
                ip: formData.get('ip'),
                port: parseInt(formData.get('port')) || 0,
                username: formData.get('username'),
                password: formData.get('password'),
                status: form.querySelector('[name="status"]').checked
            };
            
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('添加成功', 'success');
                    closeModal();
                    loadData();
                } else {
                    showToast(result.message || '添加失败', 'error');
                }
            } catch (error) {
                showToast('添加失败', 'error');
            }
        });
    }

    // 打开编辑弹窗
    async function openEditModal(id) {
        try {
            const res = await fetch(API_BASE);
            const data = await res.json();
            const item = data.data.find(i => i.id === id);
            
            if (!item) {
                showToast('未找到数据', 'error');
                return;
            }
            
            showModal('编辑节点', `
                <form id="edit-form">
                    <div class="form-group">
                        <label class="form-label">节点IP<span class="required">*</span></label>
                        <input type="text" class="form-input" name="ip" value="${escapeHtml(item.ip)}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">端口<span class="required">*</span></label>
                        <input type="number" class="form-input" name="port" value="${item.port}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">用户名</label>
                        <input type="text" class="form-input" name="username" value="${escapeHtml(item.username)}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">密码</label>
                        <input type="text" class="form-input" name="password" value="${escapeHtml(item.password)}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">状态</label>
                        <div class="form-switch">
                            <label class="switch">
                                <input type="checkbox" name="status" ${item.status ? 'checked' : ''}>
                                <span class="switch-slider"></span>
                            </label>
                            <span>已使用</span>
                        </div>
                    </div>
                </form>
            `, async () => {
                const form = document.getElementById('edit-form');
                const formData = new FormData(form);
                const updateData = {
                    ip: formData.get('ip'),
                    port: parseInt(formData.get('port')) || 0,
                    username: formData.get('username'),
                    password: formData.get('password'),
                    status: form.querySelector('[name="status"]').checked
                };
                
                try {
                    const res = await fetch(`${API_BASE}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    const result = await res.json();
                    if (result.code === 0) {
                        showToast('更新成功', 'success');
                        closeModal();
                        loadData();
                    } else {
                        showToast(result.message || '更新失败', 'error');
                    }
                } catch (error) {
                    showToast('更新失败', 'error');
                }
            });
        } catch (error) {
            showToast('加载数据失败', 'error');
        }
    }

    // 删除
    async function deleteItem(id) {
        if (!confirm('确定要删除这条记录吗？')) return;
        
        try {
            const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.code === 0) {
                showToast('删除成功', 'success');
                loadData();
            } else {
                showToast(result.message || '删除失败', 'error');
            }
        } catch (error) {
            showToast('删除失败', 'error');
        }
    }

    // 批量删除
    async function batchDelete() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        
        if (!confirm(`确定要删除选中的 ${ids.length} 条记录吗？`)) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
                updateSelection();
            } else {
                showToast(result.message || '删除失败', 'error');
            }
        } catch (error) {
            showToast('删除失败', 'error');
        }
    }

    // 批量更新状态
    async function batchUpdateStatus(status) {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids, status })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
                updateSelection();
            } else {
                showToast(result.message || '更新失败', 'error');
            }
        } catch (error) {
            showToast('更新失败', 'error');
        }
    }

    // 导出
    function exportData() {
        window.location.href = `${API_BASE}/export`;
    }

    // 导入
    async function importData(input) {
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(`${API_BASE}/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result.message || '导入失败', 'error');
            }
        } catch (error) {
            showToast('导入失败', 'error');
        }
        
        input.value = '';
    }

    // 显示导入规则
    function showImportRules() {
        showModal('导入说明', `
            <div class="import-rules">
                <h4>Excel文件格式要求：</h4>
                <table class="rules-table">
                    <thead>
                        <tr><th>列名</th><th>说明</th><th>必填</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>节点IP</td><td>节点IP地址</td><td>是</td></tr>
                        <tr><td>端口</td><td>端口号(数字)</td><td>是</td></tr>
                        <tr><td>用户名</td><td>登录用户名</td><td>否</td></tr>
                        <tr><td>密码</td><td>登录密码</td><td>否</td></tr>
                        <tr><td>状态</td><td>填写"已使用"或"未使用"</td><td>否</td></tr>
                    </tbody>
                </table>
                <p class="rules-note">提示：可先下载模板，按模板格式填写后导入。</p>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="${API_BASE}/template" class="btn btn-primary" style="text-decoration: none;">下载导入模板</a>
                </div>
            </div>
        `, () => closeModal());
    }
</script>
{% endblock %}

