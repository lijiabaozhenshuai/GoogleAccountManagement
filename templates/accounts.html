{% extends "base.html" %}

{% block content %}
<!-- 工具栏 -->
<div class="toolbar">
    <div class="toolbar-left">
        <button class="btn btn-primary" onclick="openAddModal()">
            <i data-lucide="plus"></i>
            <span>添加账号</span>
        </button>
    </div>
    <div class="toolbar-right">
        <button class="btn btn-outline" onclick="showImportRules()">
            <i data-lucide="help-circle"></i>
            <span>导入说明</span>
        </button>
        <div class="file-upload">
            <input type="file" id="import-file" accept=".xlsx,.xls" onchange="importData(this)">
            <label for="import-file" class="file-upload-label">
                <i data-lucide="upload"></i>
                <span>导入</span>
            </label>
        </div>
        <button class="btn btn-outline" onclick="exportData()">
            <i data-lucide="download"></i>
            <span>导出</span>
        </button>
    </div>
</div>

<!-- 搜索筛选栏 -->
<div class="search-container">
    <div class="search-item">
        <label class="form-label">账号</label>
        <input type="text" class="form-input" id="search-account" placeholder="搜索账号" onkeypress="handleSearchKeypress(event)">
    </div>
    <div class="search-item">
        <label class="form-label">手机号</label>
        <input type="text" class="form-input" id="search-phone" placeholder="搜索手机号" onkeypress="handleSearchKeypress(event)">
    </div>
    <div class="search-item">
        <label class="form-label">环境ID</label>
        <input type="text" class="form-input" id="search-env-id" placeholder="搜索环境ID" onkeypress="handleSearchKeypress(event)">
    </div>
    <div class="search-item">
        <label class="form-label">登录状态</label>
        <div class="multi-select-wrapper">
            <input type="text" class="form-input multi-select-display" id="login-status-display" placeholder="选择登录状态" readonly onclick="toggleMultiSelect('login-status')">
            <div class="multi-select-dropdown" id="login-status-dropdown" style="display: none;">
                <label><input type="checkbox" value="not_logged" onchange="updateMultiSelect('login-status')"> 未登录</label>
                <label><input type="checkbox" value="logging" onchange="updateMultiSelect('login-status')"> 登录中</label>
                <label><input type="checkbox" value="success" onchange="updateMultiSelect('login-status')"> 登录成功</label>
                <label><input type="checkbox" value="success_with_verification" onchange="updateMultiSelect('login-status')"> 需要安全验证</label>
                <label><input type="checkbox" value="identity_verification_failed" onchange="updateMultiSelect('login-status')"> 无法验证身份</label>
                <label><input type="checkbox" value="password_error" onchange="updateMultiSelect('login-status')"> 密码错误</label>
                <label><input type="checkbox" value="need_phone" onchange="updateMultiSelect('login-status')"> 需要手机号</label>
                <label><input type="checkbox" value="need_2fa" onchange="updateMultiSelect('login-status')"> 需要2FA</label>
                <label><input type="checkbox" value="disabled" onchange="updateMultiSelect('login-status')"> 账号禁用</label>
                <label><input type="checkbox" value="appeal_success" onchange="updateMultiSelect('login-status')"> 申诉已提交</label>
                <label><input type="checkbox" value="failed" onchange="updateMultiSelect('login-status')"> 登录失败</label>
            </div>
        </div>
    </div>
    <div class="search-item">
        <label class="form-label">频道状态</label>
        <div class="multi-select-wrapper">
            <input type="text" class="form-input multi-select-display" id="channel-status-display" placeholder="选择频道状态" readonly onclick="toggleMultiSelect('channel-status')">
            <div class="multi-select-dropdown" id="channel-status-dropdown" style="display: none;">
                <label><input type="checkbox" value="not_created" onchange="updateMultiSelect('channel-status')"> 未创建</label>
                <label><input type="checkbox" value="created" onchange="updateMultiSelect('channel-status')"> 已创建</label>
                <label><input type="checkbox" value="failed" onchange="updateMultiSelect('channel-status')"> 创建失败</label>
            </div>
        </div>
    </div>
    <div class="search-item">
        <label class="form-label">创收要求</label>
        <div class="multi-select-wrapper">
            <input type="text" class="form-input multi-select-display" id="monetization-display" placeholder="选择创收要求" readonly onclick="toggleMultiSelect('monetization')">
            <div class="multi-select-dropdown" id="monetization-dropdown" style="display: none;">
                <label><input type="checkbox" value="3m" onchange="updateMultiSelect('monetization')"> 3M</label>
                <label><input type="checkbox" value="10m" onchange="updateMultiSelect('monetization')"> 10M</label>
            </div>
        </div>
    </div>
    <div class="search-item" style="display: flex; align-items: flex-end; gap: 8px;">
        <button class="btn btn-primary" onclick="loadData()" style="margin-top: 0;">
            <i data-lucide="search"></i>
            <span>搜索</span>
        </button>
        <button class="btn btn-outline" onclick="resetFilters()" style="margin-top: 0;">
            <i data-lucide="x"></i>
            <span>重置</span>
        </button>
    </div>
</div>

<!-- 批量操作栏 -->
<div class="batch-bar" id="batch-bar">
    <span class="selected-count">已选择 <span id="selected-count">0</span> 条</span>
    <div class="batch-actions">
        <button class="btn btn-sm btn-primary" onclick="batchLogin()" style="background-color: #2563eb;">
            <i data-lucide="log-in"></i>
            <span>批量登录</span>
        </button>
        <button class="btn btn-sm btn-success" onclick="batchCreateChannel()" style="background-color: #10b981;">
            <i data-lucide="video"></i>
            <span>批量创建频道</span>
        </button>
        <button class="btn btn-sm btn-danger" onclick="stopAllTasks()" style="background-color: #dc2626;">
            <i data-lucide="square"></i>
            <span>一键暂停</span>
        </button>
        <button class="btn btn-sm btn-warning" onclick="batchResetLoginStatus()" style="background-color: #f59e0b;">
            <i data-lucide="refresh-cw"></i>
            <span>重置登录状态</span>
        </button>
        <button class="btn btn-sm btn-danger" onclick="batchDelete()">
            <i data-lucide="trash-2"></i>
            <span>批量删除</span>
        </button>
    </div>
</div>

<!-- 数据表格 -->
<div class="table-container" style="overflow-x: auto;">
    <table class="data-table" id="data-table" style="min-width: 1400px;">
        <thead>
            <tr>
                <th class="checkbox-cell" style="white-space: nowrap;">
                    <input type="checkbox" class="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th style="white-space: nowrap; min-width: 60px;">序号</th>
                <th style="white-space: nowrap; min-width: 180px;">账号</th>
                <th style="white-space: nowrap; min-width: 150px;">密码</th>
                <th style="white-space: nowrap; min-width: 180px;">辅助邮箱</th>
                <th style="white-space: nowrap; min-width: 120px;">手机号</th>
                <th style="white-space: nowrap; min-width: 90px;">登录状态</th>
                <th style="white-space: nowrap; min-width: 90px;">频道状态</th>
                <th style="white-space: nowrap; min-width: 100px;">频道链接</th>
                <th style="white-space: nowrap; min-width: 90px;">创收要求</th>
                <th style="white-space: nowrap; min-width: 120px;">环境ID</th>
                <th style="white-space: nowrap; min-width: 100px;">创建时间</th>
                <th class="actions-cell" style="white-space: nowrap; min-width: 180px;">操作</th>
            </tr>
        </thead>
        <tbody id="table-body">
            <!-- 数据动态加载 -->
        </tbody>
    </table>
    <div class="empty-state" id="empty-state" style="display: none;">
        <i data-lucide="inbox"></i>
        <p>暂无数据</p>
    </div>
</div>

<!-- 分页控件 -->
<div class="pagination-container" id="pagination-container" style="display: none;">
    <div class="pagination-info">
        共 <span id="total-count">0</span> 条记录，第 <span id="current-page">1</span> / <span id="total-pages">1</span> 页
    </div>
    <div class="pagination-controls">
        <button class="btn btn-sm btn-outline" onclick="goToPage(1)" id="first-page-btn">
            <i data-lucide="chevrons-left"></i>
        </button>
        <button class="btn btn-sm btn-outline" onclick="goToPage(currentPage - 1)" id="prev-page-btn">
            <i data-lucide="chevron-left"></i>
        </button>
        <span class="pagination-pages" id="page-numbers"></span>
        <button class="btn btn-sm btn-outline" onclick="goToPage(currentPage + 1)" id="next-page-btn">
            <i data-lucide="chevron-right"></i>
        </button>
        <button class="btn btn-sm btn-outline" onclick="goToPage(totalPages)" id="last-page-btn">
            <i data-lucide="chevrons-right"></i>
        </button>
    </div>
</div>

<!-- 日志弹窗 -->
<div class="modal-overlay" id="log-modal" style="display: none;">
    <div class="modal" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="log-modal-title">登录日志</h3>
            <button class="modal-close" onclick="closeLogModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="log-container" id="log-container">
                <!-- 日志内容动态加载 -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeLogModal()">关闭</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .login-status-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
    }
    .login-status-tag.not_logged { background: #f3f4f6; color: #6b7280; }
    .login-status-tag.logging { background: #dbeafe; color: #2563eb; }
    .login-status-tag.success { background: #d1fae5; color: #059669; }
    .login-status-tag.password_error { background: #fee2e2; color: #dc2626; }
    .login-status-tag.identity_verification_failed { background: #fef3c7; color: #b45309; }
    .login-status-tag.need_phone { background: #fef3c7; color: #d97706; }
    .login-status-tag.need_2fa { background: #fef3c7; color: #d97706; }
    .login-status-tag.disabled { background: #fee2e2; color: #dc2626; }
    .login-status-tag.appealing { background: #e0e7ff; color: #4f46e5; }
    .login-status-tag.appeal_success { background: #ddd6fe; color: #7c3aed; }
    .login-status-tag.failed { background: #fee2e2; color: #dc2626; }
    
    /* 频道状态样式 */
    .channel-status-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
    }
    .channel-status-tag.not_created { background: #f3f4f6; color: #6b7280; }
    .channel-status-tag.created { background: #d1fae5; color: #059669; }
    .channel-status-tag.failed { background: #fee2e2; color: #dc2626; }
    
    /* 创收要求样式 */
    .monetization-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
    }
    .monetization-tag.req-3m { 
        background: #d1fae5; 
        color: #059669; 
        border: 1px solid #059669;
    }
    .monetization-tag.req-10m { 
        background: #fee2e2; 
        color: #dc2626; 
        border: 1px solid #dc2626;
    }
    
    .channel-url-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .channel-url-cell a {
        color: #2563eb;
        text-decoration: none;
    }
    .channel-url-cell a:hover {
        text-decoration: underline;
    }
    
    .env-id-cell {
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 14px;
        color: var(--text-muted);
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .action-btns {
        display: flex;
        gap: 4px;
        justify-content: center;
        flex-wrap: nowrap;
    }
    
    .action-btn.login { color: #2563eb; }
    .action-btn.login:hover { background: #dbeafe; }
    .action-btn.channel { color: #ef4444; }
    .action-btn.channel:hover { background: #fee2e2; }
    .action-btn.log { color: #8b5cf6; }
    .action-btn.log:hover { background: #ede9fe; }
    .action-btn.reset { color: #f59e0b; }
    .action-btn.reset:hover { background: #fef3c7; }
    
    .log-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .log-item {
        display: flex;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
    }
    
    .log-item:last-child {
        border-bottom: none;
    }
    
    .log-time {
        color: var(--text-muted);
        white-space: nowrap;
        font-size: 14px;
    }
    
    .log-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
    }
    
    .log-status.start { background: #dbeafe; color: #2563eb; }
    .log-status.info { background: #f3f4f6; color: #6b7280; }
    .log-status.success { background: #d1fae5; color: #059669; }
    .log-status.failed { background: #fee2e2; color: #dc2626; }
    .log-status.password_error { background: #fee2e2; color: #dc2626; }
    .log-status.identity_verification_failed { background: #fef3c7; color: #b45309; }
    .log-status.need_phone { background: #fef3c7; color: #d97706; }
    .log-status.need_2fa { background: #fef3c7; color: #d97706; }
    .log-status.disabled { background: #fee2e2; color: #dc2626; }
    .log-status.appealing { background: #e0e7ff; color: #4f46e5; }
    .log-status.appeal_success { background: #ddd6fe; color: #7c3aed; }
    
    .log-message {
        color: var(--text-primary);
        flex: 1;
    }
    
    .log-empty {
        text-align: center;
        padding: 40px;
        color: var(--text-muted);
    }
    
    .logging-spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #2563eb;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* 多选下拉框样式 */
    .multi-select-wrapper {
        position: relative;
        width: 160px;
    }
    
    .multi-select-display {
        cursor: pointer;
        background: #ffffff;
    }
    
    .multi-select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        margin-top: 4px;
    }
    
    .multi-select-dropdown label {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.2s;
        margin: 0;
        font-weight: normal;
    }
    
    .multi-select-dropdown label:hover {
        background: var(--primary-light);
    }
    
    .multi-select-dropdown input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
    }
    
    /* 分页样式 */
    .pagination-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-top: 16px;
        box-shadow: var(--shadow-sm);
    }
    
    .pagination-info {
        color: var(--text-muted);
        font-size: 14px;
    }
    
    .pagination-info span {
        color: var(--text-primary);
        font-weight: 500;
    }
    
    .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .pagination-pages {
        display: flex;
        gap: 4px;
    }
    
    .pagination-page-btn {
        min-width: 32px;
        height: 32px;
        padding: 4px 8px;
        border: 1px solid var(--border-color);
        background: #ffffff;
        color: var(--text-primary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }
    
    .pagination-page-btn:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
    }
    
    .pagination-page-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }
</style>

<script>
    const API_BASE = '/api/accounts';
    const COLUMNS = ['account', 'password', 'backup_email'];
    const COLUMN_LABELS = {
        account: '账号',
        password: '密码',
        backup_email: '辅助邮箱'
    };
    
    const LOGIN_STATUS_MAP = {
        'not_logged': '未登录',
        'logging': '登录中',
        'success': '登录成功',
        'success_with_verification': '需要安全验证',
        'identity_verification_failed': '无法验证身份',
        'password_error': '密码错误',
        'need_phone': '需要手机号',
        'need_2fa': '需要2FA',
        'disabled': '账号禁用',
        'appealing': '申诉中',
        'appeal_success': '申诉已提交',
        'failed': '登录失败'
    };
    
    const CHANNEL_STATUS_MAP = {
        'not_created': '未创建',
        'created': '已创建',
        'failed': '创建失败'
    };

    // 分页相关变量
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 1;
    let totalCount = 0;
    // 使用window.selectedIds确保跨文件可访问
    window.selectedIds = window.selectedIds || new Set();

    // 页面加载时获取数据
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        // 每10秒自动刷新一次
        setInterval(loadData, 10000);
    });

    // 回车键触发搜索
    function handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            currentPage = 1;
            loadData();
        }
    }
    
    // 多选框控制
    function toggleMultiSelect(id) {
        const dropdown = document.getElementById(`${id}-dropdown`);
        const allDropdowns = document.querySelectorAll('.multi-select-dropdown');
        allDropdowns.forEach(d => {
            if (d.id !== `${id}-dropdown`) {
                d.style.display = 'none';
            }
        });
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }
    
    // 更新多选框显示
    function updateMultiSelect(id) {
        const dropdown = document.getElementById(`${id}-dropdown`);
        const display = document.getElementById(`${id}-display`);
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.nextSibling.textContent.trim());
        
        if (selected.length === 0) {
            display.value = '';
        } else if (selected.length === 1) {
            display.value = selected[0];
        } else {
            display.value = `已选择 ${selected.length} 项`;
        }
        
        loadData();
    }
    
    // 获取选中的多选值
    function getMultiSelectValues(id) {
        const dropdown = document.getElementById(`${id}-dropdown`);
        const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]:checked');
        return Array.from(checkboxes).map(cb => cb.value);
    }
    
    // 点击外部关闭下拉框
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.multi-select-wrapper')) {
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                d.style.display = 'none';
            });
        }
    });
    
    // 加载数据
    async function loadData() {
        try {
            // 构建查询参数
            const params = new URLSearchParams({
                page: currentPage,
                page_size: pageSize
            });
            
            // 添加搜索参数
            const accountSearch = document.getElementById('search-account')?.value.trim();
            if (accountSearch) params.append('account', accountSearch);
            
            const phoneSearch = document.getElementById('search-phone')?.value.trim();
            if (phoneSearch) params.append('phone', phoneSearch);
            
            const envIdSearch = document.getElementById('search-env-id')?.value.trim();
            if (envIdSearch) params.append('env_id', envIdSearch);
            
            // 添加多选筛选参数
            const loginStatusValues = getMultiSelectValues('login-status');
            loginStatusValues.forEach(status => params.append('login_status', status));
            
            const channelStatusValues = getMultiSelectValues('channel-status');
            channelStatusValues.forEach(status => params.append('channel_status', status));
            
            const monetizationValues = getMultiSelectValues('monetization');
            monetizationValues.forEach(req => params.append('monetization', req));
            
            const res = await fetch(`${API_BASE}?${params.toString()}`);
            const data = await res.json();
            totalCount = data.total;
            totalPages = data.total_pages;
            renderTable(data.data);
            renderPagination();
        } catch (error) {
            showToast('加载数据失败', 'error');
        }
    }
    
    // 重置筛选条件
    function resetFilters() {
        document.getElementById('search-account').value = '';
        document.getElementById('search-phone').value = '';
        document.getElementById('search-env-id').value = '';
        
        // 重置多选框
        document.querySelectorAll('.multi-select-dropdown input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
        });
        document.getElementById('login-status-display').value = '';
        document.getElementById('channel-status-display').value = '';
        document.getElementById('monetization-display').value = '';
        
        currentPage = 1;
        loadData();
    }
    
    // 渲染分页控件
    function renderPagination() {
        const container = document.getElementById('pagination-container');
        const totalCountEl = document.getElementById('total-count');
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        const pageNumbersEl = document.getElementById('page-numbers');
        
        if (totalCount === 0 || totalPages <= 1) {
            container.style.display = 'none';
            return;
        }
        
        container.style.display = 'flex';
        totalCountEl.textContent = totalCount;
        currentPageEl.textContent = currentPage;
        totalPagesEl.textContent = totalPages;
        
        // 生成页码按钮（最多显示7个页码）
        let pages = [];
        if (totalPages <= 7) {
            pages = Array.from({ length: totalPages }, (_, i) => i + 1);
        } else {
            if (currentPage <= 4) {
                pages = [1, 2, 3, 4, 5, '...', totalPages];
            } else if (currentPage >= totalPages - 3) {
                pages = [1, '...', totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
            } else {
                pages = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages];
            }
        }
        
        pageNumbersEl.innerHTML = pages.map(page => {
            if (page === '...') {
                return '<span style="padding: 0 8px;">...</span>';
            }
            return `<button class="pagination-page-btn ${page === currentPage ? 'active' : ''}" onclick="goToPage(${page})">${page}</button>`;
        }).join('');
        
        // 更新按钮状态
        document.getElementById('first-page-btn').disabled = currentPage === 1;
        document.getElementById('prev-page-btn').disabled = currentPage === 1;
        document.getElementById('next-page-btn').disabled = currentPage === totalPages;
        document.getElementById('last-page-btn').disabled = currentPage === totalPages;
        
        lucide.createIcons();
    }
    
    // 跳转到指定页
    function goToPage(page) {
        if (page < 1 || page > totalPages || page === currentPage) return;
        currentPage = page;
        loadData();
    }

    // 渲染表格
    function renderTable(items) {
        const tbody = document.getElementById('table-body');
        const emptyState = document.getElementById('empty-state');
        
        if (!items || items.length === 0) {
            tbody.innerHTML = '';
            emptyState.style.display = 'flex';
            return;
        }
        
        emptyState.style.display = 'none';
        tbody.innerHTML = items.map((item, index) => {
            const loginStatus = item.login_status || 'not_logged';
            const loginStatusText = LOGIN_STATUS_MAP[loginStatus] || '未知';
            const isLogging = loginStatus === 'logging';
            
            const channelStatus = item.channel_status || 'not_created';
            const channelStatusText = CHANNEL_STATUS_MAP[channelStatus] || '未创建';
            const channelUrl = item.channel_url || '';
            
            // 计算序号（全局序号）
            const rowNumber = (currentPage - 1) * pageSize + index + 1;
            
            // 检查是否已勾选（跨页保持）
            const isChecked = window.selectedIds && window.selectedIds.has(item.id);
            
            return `
            <tr data-id="${item.id}">
                <td class="checkbox-cell">
                    <input type="checkbox" class="checkbox row-checkbox" value="${item.id}" onchange="updateSelection()" ${isChecked ? 'checked' : ''}>
                </td>
                <td>${rowNumber}</td>
                <td>${escapeHtml(item.account)}</td>
                <td>${escapeHtml(item.password)}</td>
                <td>${escapeHtml(item.backup_email)}</td>
                <td>${item.phone_number ? escapeHtml(item.phone_number) : '-'}</td>
                <td>
                    <span class="login-status-tag ${loginStatus}">
                        ${isLogging ? '<span class="logging-spinner"></span>' : ''}
                        ${loginStatusText}
                    </span>
                </td>
                <td>
                    <span class="channel-status-tag ${channelStatus}">
                        ${channelStatusText}
                    </span>
                </td>
                <td class="channel-url-cell" title="${escapeHtml(channelUrl)}">
                    ${channelUrl ? `<a href="${escapeHtml(channelUrl)}" target="_blank">查看频道</a>` : '-'}
                </td>
                <td>
                    ${item.monetization_requirement ? 
                        `<span class="monetization-tag req-${item.monetization_requirement}">${item.monetization_requirement.toUpperCase()}</span>` 
                        : '-'}
                </td>
                <td class="env-id-cell" title="${escapeHtml(item.browser_env_id || '')}">${escapeHtml(item.browser_env_id || '-')}</td>
                <td>${item.created_at}</td>
                <td class="actions-cell">
                    <div class="action-btns">
                        <button class="action-btn login" onclick="autoLogin(${item.id})" title="自动登录" ${isLogging ? 'disabled' : ''}>
                            <i data-lucide="log-in"></i>
                        </button>
                        ${isLogging ? `<button class="action-btn reset" onclick="resetLoginStatus(${item.id})" title="重置登录状态" style="color: #f59e0b;">
                            <i data-lucide="refresh-cw"></i>
                        </button>` : ''}
                        ${(loginStatus === 'success' || loginStatus === 'success_with_verification') ? `<button class="action-btn channel" onclick="createChannel(${item.id})" title="${channelStatus === 'created' ? '检测创收要求' : '创建频道'}" style="color: ${channelStatus === 'created' ? '#10b981' : '#ef4444'};">
                            <i data-lucide="${channelStatus === 'created' ? 'refresh-ccw' : 'video'}"></i>
                        </button>` : ''}
                        <button class="action-btn log" onclick="viewLogs(${item.id})" title="查看日志">
                            <i data-lucide="file-text"></i>
                        </button>
                        <button class="action-btn reset" onclick="resetStatus(${item.id})" title="重置状态" ${isLogging ? 'disabled' : ''}>
                            <i data-lucide="rotate-ccw"></i>
                        </button>
                        <button class="action-btn edit" onclick="openEditModal(${item.id})" title="编辑">
                            <i data-lucide="pencil"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteItem(${item.id})" title="删除">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `}).join('');
        
        lucide.createIcons();
        
        // 渲染完成后更新选择状态
        updateSelection();
    }
    
    // 自动登录
    async function autoLogin(id) {
        if (!confirm('确定要自动登录这个账号吗？')) return;
        
        try {
            const res = await fetch(`${API_BASE}/${id}/auto-login`, {
                method: 'POST'
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
    
    // 重置登录状态
    async function resetLoginStatus(id) {
        if (!confirm('确定要重置这个账号的登录状态吗？\n这将清除"登录中"状态，让您可以重新登录。')) return;
        
        try {
            const res = await fetch(`${API_BASE}/${id}/reset-login-status`, {
                method: 'POST'
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast('登录状态已重置', 'success');
                loadData();
            } else {
                showToast(result.message || '重置失败', 'error');
            }
        } catch (error) {
            showToast('重置失败', 'error');
        }
    }
    
    // 查看日志
    async function viewLogs(id) {
        try {
            const res = await fetch(`${API_BASE}/${id}/logs`);
            const result = await res.json();
            
            if (result.code === 0) {
                const modal = document.getElementById('log-modal');
                const title = document.getElementById('log-modal-title');
                const container = document.getElementById('log-container');
                
                title.textContent = `登录日志 - ${result.account}`;
                
                if (result.data.length === 0) {
                    container.innerHTML = '<div class="log-empty"><i data-lucide="inbox"></i><p>暂无日志记录</p></div>';
                } else {
                    container.innerHTML = result.data.map(log => `
                        <div class="log-item">
                            <span class="log-time">${log.created_at}</span>
                            <span class="log-status ${log.status}">${log.status}</span>
                            <span class="log-message">${escapeHtml(log.message)}</span>
                        </div>
                    `).join('');
                }
                
                modal.style.display = 'flex';
                lucide.createIcons();
            } else {
                showToast(result.message || '获取日志失败', 'error');
            }
        } catch (error) {
            showToast('获取日志失败', 'error');
        }
    }
    
    // 关闭日志弹窗
    function closeLogModal() {
        document.getElementById('log-modal').style.display = 'none';
    }
    
    // 重置状态
    async function resetStatus(id) {
        if (!confirm('确定要重置这个账号的登录状态吗？')) return;
        
        try {
            const res = await fetch(`${API_BASE}/${id}/reset-status`, {
                method: 'POST'
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }

    // 打开添加弹窗
    function openAddModal() {
        const fields = COLUMNS.map(col => `
            <div class="form-group">
                <label class="form-label">${COLUMN_LABELS[col]}<span class="required">*</span></label>
                <input type="text" class="form-input" name="${col}" required>
            </div>
        `).join('');
        
        showModal('添加账号', `
            <form id="add-form">
                ${fields}
            </form>
        `, async () => {
            const form = document.getElementById('add-form');
            const formData = new FormData(form);
            const data = {
                account: formData.get('account'),
                password: formData.get('password'),
                backup_email: formData.get('backup_email')
            };
            
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.code === 0) {
                    showToast('添加成功', 'success');
                    closeModal();
                    loadData();
                } else {
                    showToast(result.message || '添加失败', 'error');
                }
            } catch (error) {
                showToast('添加失败', 'error');
            }
        });
    }

    // 打开编辑弹窗
    async function openEditModal(id) {
        try {
            // 获取账号数据
            const res = await fetch(API_BASE);
            const data = await res.json();
            const item = data.data.find(i => i.id === id);
            
            if (!item) {
                showToast('未找到数据', 'error');
                return;
            }
            
            // 获取所有可用的浏览器环境
            const browsersRes = await fetch('/api/hubstudio/browsers?page_size=1000');
            const browsersData = await browsersRes.json();
            const environments = browsersData.data || [];
            
            const fields = COLUMNS.map(col => `
                <div class="form-group">
                    <label class="form-label">${COLUMN_LABELS[col]}<span class="required">*</span></label>
                    <input type="text" class="form-input" name="${col}" value="${escapeHtml(item[col])}" required>
                </div>
            `).join('');
            
            // 添加环境ID选择框
            const envOptions = `
                <option value="">-- 不选择环境 --</option>
                ${environments.map(env => {
                    const displayText = env.containerName 
                        ? `${escapeHtml(env.containerName)} (${escapeHtml(env.containerCode)})`
                        : escapeHtml(env.containerCode);
                    return `
                        <option value="${escapeHtml(env.containerCode)}" ${item.browser_env_id === env.containerCode ? 'selected' : ''}>
                            ${displayText}
                        </option>
                    `;
                }).join('')}
            `;
            
            showModal('编辑账号', `
                <form id="edit-form">
                    ${fields}
                    <div class="form-group">
                        <label class="form-label">环境ID</label>
                        <select class="form-input" name="browser_env_id" style="cursor: pointer;">
                            ${envOptions}
                        </select>
                    </div>
                </form>
            `, async () => {
                const form = document.getElementById('edit-form');
                const formData = new FormData(form);
                const updateData = {
                    account: formData.get('account'),
                    password: formData.get('password'),
                    backup_email: formData.get('backup_email'),
                    browser_env_id: formData.get('browser_env_id') || null
                };
                
                try {
                    const res = await fetch(`${API_BASE}/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    const result = await res.json();
                    if (result.code === 0) {
                        showToast('更新成功', 'success');
                        closeModal();
                        loadData();
                    } else {
                        showToast(result.message || '更新失败', 'error');
                    }
                } catch (error) {
                    showToast('更新失败', 'error');
                }
            });
        } catch (error) {
            showToast('加载数据失败', 'error');
        }
    }

    // 删除
    async function deleteItem(id) {
        if (!confirm('确定要删除这条记录吗？')) return;
        
        try {
            const res = await fetch(`${API_BASE}/${id}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.code === 0) {
                showToast('删除成功', 'success');
                loadData();
            } else {
                showToast(result.message || '删除失败', 'error');
            }
        } catch (error) {
            showToast('删除失败', 'error');
        }
    }

    // 批量重置登录状态
    async function batchResetLoginStatus() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            showToast('请先选择要重置的账号', 'warning');
            return;
        }
        
        if (!confirm(`确定要重置选中的 ${ids.length} 个账号的登录状态吗？\n这将清除"登录中"状态。`)) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-reset-login-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
                clearSelection();
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
    
    // 批量删除
    async function batchDelete() {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        
        if (!confirm(`确定要删除选中的 ${ids.length} 条记录吗？`)) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
                updateSelection();
            } else {
                showToast(result.message || '删除失败', 'error');
            }
        } catch (error) {
            showToast('删除失败', 'error');
        }
    }

    // 批量更新状态
    async function batchUpdateStatus(status) {
        const ids = getSelectedIds();
        if (ids.length === 0) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids, status })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
                updateSelection();
            } else {
                showToast(result.message || '更新失败', 'error');
            }
        } catch (error) {
            showToast('更新失败', 'error');
        }
    }

    // 导出
    function exportData() {
        window.location.href = `${API_BASE}/export`;
    }

    // 导入
    async function importData(input) {
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch(`${API_BASE}/import`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                loadData();
            } else {
                showToast(result.message || '导入失败', 'error');
            }
        } catch (error) {
            showToast('导入失败', 'error');
        }
        
        input.value = '';
    }

    // 显示导入规则
    function showImportRules() {
        showModal('导入说明', `
            <div class="import-rules">
                <h4>Excel文件格式要求：</h4>
                <table class="rules-table">
                    <thead>
                        <tr>
                            <th>列名</th>
                            <th>说明</th>
                            <th>必填</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>账号</td><td>Google账号邮箱</td><td>是</td></tr>
                        <tr><td>密码</td><td>账号密码</td><td>是</td></tr>
                        <tr><td>辅助邮箱</td><td>备用邮箱地址</td><td>否</td></tr>
                    </tbody>
                </table>
                <p class="rules-note">提示：可先下载模板，按模板格式填写后导入。</p>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="${API_BASE}/template" class="btn btn-primary" style="text-decoration: none;">
                        <i data-lucide="download"></i>
                        下载导入模板
                    </a>
                </div>
            </div>
        `, () => closeModal());
        
        // 重新渲染图标
        setTimeout(() => lucide.createIcons(), 100);
    }
    
    // 创建YouTube频道
    async function createChannel(id) {
        try {
            // 获取账号数据，判断是否已创建频道
            const res = await fetch(API_BASE);
            const data = await res.json();
            const account = data.data.find(i => i.id === id);
            
            if (!account) {
                showToast('未找到账号', 'error');
                return;
            }
            
            // 判断是创建频道还是检测创收要求
            const isChannelCreated = account.channel_status === 'created' && account.channel_url;
            
            if (isChannelCreated) {
                // 已创建频道，执行检测操作
                if (!confirm('确定要检测这个频道的创收要求吗？\n\n将自动跳转到YouTube Studio创收页面进行检测。')) return;
            } else {
                // 未创建频道，执行创建操作
                if (!confirm('确定要为这个账号创建YouTube频道吗？\n\n注意：\n1. 账号必须已登录成功\n2. 需要配置头像文件夹路径\n3. 频道名称将随机生成\n4. 创建成功后会删除使用的头像')) return;
                
                // 只有创建频道时才检查头像可用性
                const checkRes = await fetch('/api/channels/check-avatar-availability');
                const checkResult = await checkRes.json();
                
                if (checkResult.code !== 0) {
                    showToast(checkResult.message, 'error');
                    return;
                }
            }
            
            // 开始创建频道或检测创收要求
            const apiRes = await fetch(`/api/channels/${id}/create-channel`, {
                method: 'POST'
            });
            const result = await apiRes.json();
            
            if (result.code === 0) {
                showToast(result.message, 'success');
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
    
    // 批量登录
    async function batchLogin() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            showToast('请先选择要登录的账号', 'warning');
            return;
        }
        
        if (!confirm(`确定要批量登录选中的 ${ids.length} 个账号吗？\n\n注意：\n1. 将自动以3个并发执行\n2. 每个账号间隔1-2秒\n3. 请确保有足够的浏览器环境`)) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                // 清空选择
                clearSelection();
                // 刷新数据
                setTimeout(() => loadData(), 1000);
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
    
    // 批量创建频道
    async function batchCreateChannel() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            showToast('请先选择要创建频道的账号', 'warning');
            return;
        }
        
        if (!confirm(`确定要批量创建频道选中的 ${ids.length} 个账号吗？\n\n注意：\n1. 账号必须已登录成功\n2. 将自动以3个并发执行\n3. 每个账号间隔1-2秒\n4. 请确保头像文件夹有足够的头像`)) return;
        
        try {
            const res = await fetch(`${API_BASE}/batch-create-channel`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids })
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
                // 清空选择
                clearSelection();
                // 刷新数据
                setTimeout(() => loadData(), 1000);
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
    
    // 一键暂停所有任务
    async function stopAllTasks() {
        if (!confirm('确定要停止所有正在执行的批量任务吗？\n\n当前任务将在完成后停止。')) return;
        
        try {
            const res = await fetch(`${API_BASE}/stop-all-tasks`, {
                method: 'POST'
            });
            const result = await res.json();
            if (result.code === 0) {
                showToast(result.message, 'success');
            } else {
                showToast(result.message || '操作失败', 'error');
            }
        } catch (error) {
            showToast('操作失败', 'error');
        }
    }
</script>
{% endblock %}

